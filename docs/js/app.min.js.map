{"version":3,"sources":["docs/js/app.js"],"names":["GlslCanvas","prototype","TEXTURE_COUNT","BUFFER_COUNT","createBuffer","W","H","program","glsl","this","gl","index","getExtension","texture","createTexture","activeTexture","TEXTURE0","bindTexture","TEXTURE_2D","texImage2D","RGBA","FLOAT","texParameteri","TEXTURE_MIN_FILTER","NEAREST","TEXTURE_MAG_FILTER","TEXTURE_WRAP_S","CLAMP_TO_EDGE","TEXTURE_WRAP_T","buffer","createFramebuffer","resize","bindFramebuffer","FRAMEBUFFER","minW","Math","min","minH","pixels","Float32Array","readPixels","newIndex","newTexture","texSubImage2D","newBuffer","deleteTexture","console","log","createSwappableBuffer","input","output","swap","temp","render","name","useProgram","viewport","framebufferTexture2D","COLOR_ATTACHMENT0","drawArrays","TRIANGLES","load","fragString","vertString","vertexString","fragmentString","animated","nDelta","match","length","nTime","nDate","nMouse","search","lines","split","i","ext","pop","toLowerCase","setUniform","main","vertexShader","createShader","VERTEX_SHADER","fragmentShader","FRAGMENT_SHADER","isValid","createProgram","deleteShader","change","trigger","forceRender","loadPrograms","buffers","vertex","key","fragment","common","line","bundle","canvas","width","height","loadUniforms","options","textures","uniformTexture","filtering","repeat","updateVariables","date","Date","now","performance","variables","prev","delta","timeLoad","time","year","getFullYear","month","getMonth","getDate","daytime","getHours","getMinutes","getSeconds","getMilliseconds","UpdateUniforms","uniform2f","getUniformLocation","uniform1f","uniform4f","uniform1i","resizeSwappableBuffers","Object","keys","renderPrograms","visible","getBoundingClientRect","top","window","innerHeight","document","documentElement","clientHeight","paused","setMouse","mouse","rect","x","left","right","y","bottom","_resize","source","type","offset","shader","shaderSource","compileShader","getShaderParameter","COMPILE_STATUS","lastError","getShaderInfoLog","error","shaders","optAttribs","optLocations","attachShader","bindAttribLocation","linkProgram","getProgramParameter","LINK_STATUS","getProgramInfoLog","deleteProgram","flag","apply","CanvasService","onGlslError","message","errors","warnings","replace","m","l","v","t","Number","li","encodeURI","JSON","stringify","uri","push","warning","join","querySelector","setAttribute","innerHTML","addEventListener","url","callback","request","linediff","RegExp","end","substr","content","btnDownload","ri","premultipliedAlpha","preserveDrawingBuffer","backgroundColor","init","w","offsetWidth","h","offsetHeight","style","on","trim","zip","JSZip","Promise","all","map","resolve","XMLHttpRequest","open","onload","file","responseText","send","then","generateAsync","saveAs","clearTimeout","setTimeout","createCanvas"],"mappings":"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","file":"app.min.js","sourcesContent":["/* global window, document, console, GlslCanvas */\r\n\r\n(function () {\r\n    'use strict';\r\n\r\n    function CanvasService(canvas, options) {\r\n        return new GlslCanvas(canvas, options);\r\n    }\r\n\r\n    GlslCanvas.prototype.TEXTURE_COUNT = 0;\r\n    GlslCanvas.prototype.BUFFER_COUNT = 0;\r\n    GlslCanvas.prototype.createBuffer = createBuffer;\r\n    GlslCanvas.prototype.createSwappableBuffer = createSwappableBuffer;\r\n    GlslCanvas.prototype.load = load;\r\n    GlslCanvas.prototype.loadPrograms = loadPrograms;\r\n    GlslCanvas.prototype.loadUniforms = loadUniforms;\r\n    GlslCanvas.prototype.updateVariables = updateVariables;\r\n    GlslCanvas.prototype.UpdateUniforms = UpdateUniforms;\r\n    GlslCanvas.prototype.resizeSwappableBuffers = resizeSwappableBuffers;\r\n    GlslCanvas.prototype.renderPrograms = renderPrograms;\r\n    GlslCanvas.prototype.render = render;\r\n\r\n    var _setMouse = GlslCanvas.prototype.setMouse;\r\n    GlslCanvas.prototype.setMouse = setMouse;\r\n\r\n    var _resize = GlslCanvas.prototype.resize;\r\n    GlslCanvas.prototype.resize = resize;\r\n\r\n    function load(fragString, vertString) {\r\n        var glsl = this,\r\n            gl = glsl.gl;\r\n        // Load vertex shader if there is one\r\n        if (vertString) {\r\n            glsl.vertexString = vertString;\r\n        }\r\n        // Load fragment shader if there is one\r\n        if (fragString) {\r\n            glsl.fragmentString = fragString;\r\n        }\r\n        glsl.animated = false;\r\n        glsl.nDelta = (glsl.fragmentString.match(/u_delta/g) || []).length;\r\n        glsl.nTime = (glsl.fragmentString.match(/u_time/g) || []).length;\r\n        glsl.nDate = (glsl.fragmentString.match(/u_date/g) || []).length;\r\n        glsl.nMouse = (glsl.fragmentString.match(/u_mouse/g) || []).length;\r\n        glsl.animated = glsl.nDate > 1 || glsl.nTime > 1 || glsl.nMouse > 1;\r\n        var nTextures = glsl.fragmentString.search(/sampler2D/g);\r\n        if (nTextures) {\r\n            var lines = glsl.fragmentString.split('\\n');\r\n            for (var i = 0; i < lines.length; i++) {\r\n                var match = lines[i].match(/uniform\\s*sampler2D\\s*([\\w]*);\\s*\\/\\/\\s*([\\w|\\:\\/\\/|\\.|\\-|\\_]*)/i);\r\n                if (match) {\r\n                    var ext = match[2].split('.').pop().toLowerCase();\r\n                    if (match[1] && match[2] && (ext === 'jpg' || ext === 'jpeg' || ext === 'png' || ext === 'ogv' || ext === 'webm' || ext === 'mp4')) {\r\n                        glsl.setUniform(match[1], match[2]);\r\n                    }\r\n                }\r\n                var main = lines[i].match(/\\s*void\\s*main\\s*/g);\r\n                if (main) {\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n        var vertexShader = createShader(glsl, glsl.vertexString, gl.VERTEX_SHADER);\r\n        var fragmentShader = createShader(glsl, glsl.fragmentString, gl.FRAGMENT_SHADER);\r\n        // If Fragment shader fails load a empty one to sign the error\r\n        if (!fragmentShader) {\r\n            fragmentShader = createShader(glsl, 'void main(){\\n\\tgl_FragColor = vec4(1.0);\\n}', gl.FRAGMENT_SHADER);\r\n            glsl.isValid = false;\r\n        } else {\r\n            glsl.isValid = true;\r\n        }\r\n        // Create and use program\r\n        var program = createProgram(glsl, [vertexShader, fragmentShader]); //, [0,1],['a_texcoord','a_position']);\r\n        gl.useProgram(program);\r\n        // Delete shaders\r\n        // gl.detachShader(program, vertexShader);\r\n        // gl.detachShader(program, fragmentShader);\r\n        gl.deleteShader(vertexShader);\r\n        gl.deleteShader(fragmentShader);\r\n        glsl.program = program;\r\n        glsl.change = true;\r\n        // Trigger event\r\n        glsl.trigger('load', {});\r\n        glsl.forceRender = true;\r\n    }\r\n\r\n    function loadPrograms(buffers) {\r\n        var glsl = this,\r\n            gl = glsl.gl,\r\n            i = 0;\r\n        glsl.buffers = {};\r\n        var vertex = createShader(glsl, glsl.vertexString, gl.VERTEX_SHADER);\r\n        for (var key in buffers) {\r\n            var buffer = buffers[key];\r\n            var fragment = createShader(glsl, buffer.common + buffer.fragment, gl.FRAGMENT_SHADER, buffer.line);\r\n            if (!fragment) {\r\n                fragment = createShader(glsl, 'void main(){\\n\\tgl_FragColor = vec4(1.0);\\n}', gl.FRAGMENT_SHADER);\r\n                glsl.isValid = false;\r\n            } else {\r\n                glsl.isValid = true;\r\n            }\r\n            var program = createProgram(glsl, [vertex, fragment]);\r\n            buffer.name = 'u_buffer_' + i;\r\n            buffer.program = program;\r\n            buffer.bundle = glsl.createSwappableBuffer(glsl.canvas.width, glsl.canvas.height, program);\r\n            // console.log(i, key, buffer.common + buffer.fragment, buffer.bundle);\r\n            glsl.buffers[key] = buffer;\r\n            gl.deleteShader(fragment);\r\n            i++;\r\n        }\r\n        gl.deleteShader(vertex);\r\n    }\r\n\r\n    function loadUniforms(options) {\r\n        var glsl = this,\r\n            gl = glsl.gl;\r\n        if (options.textures) {\r\n            for (var key in options.textures) {\r\n                glsl.uniformTexture('u_texture_' + key, options.textures[key], {\r\n                    filtering: 'mipmap',\r\n                    repeat: true,\r\n                });\r\n            }\r\n        }\r\n    }\r\n\r\n    function render() {\r\n        var glsl = this,\r\n            gl = glsl.gl;\r\n        glsl.visible = isCanvasVisible(glsl.canvas);\r\n        if (glsl.forceRender || (glsl.animated && glsl.visible && !glsl.paused)) {\r\n            glsl.renderPrograms();\r\n            glsl.change = false;\r\n            glsl.forceRender = false;\r\n            glsl.trigger('render', {});\r\n        }\r\n    }\r\n\r\n    function renderPrograms() {\r\n        var glsl = this,\r\n            gl = glsl.gl,\r\n            W = gl.canvas.width,\r\n            H = gl.canvas.height;\r\n        glsl.updateVariables();\r\n        gl.viewport(0, 0, W, H);\r\n        if (glsl.buffers && Object.keys(glsl.buffers).length > 0) {\r\n            for (var key in glsl.buffers) {\r\n                var buffer = glsl.buffers[key];\r\n                glsl.UpdateUniforms(buffer.program, key);\r\n                buffer.bundle.render(W, H, buffer.program, buffer.name);\r\n            }\r\n            gl.bindFramebuffer(gl.FRAMEBUFFER, null);\r\n        }\r\n        glsl.UpdateUniforms(glsl.program, 'main');\r\n        gl.drawArrays(gl.TRIANGLES, 0, 6);\r\n    }\r\n\r\n    function resize() {\r\n        var glsl = this;\r\n        var flag = _resize.apply(glsl);\r\n        if (flag) {\r\n            glsl.resizeSwappableBuffers();\r\n        }\r\n        return flag;\r\n    }\r\n\r\n    function resizeSwappableBuffers() {\r\n        var glsl = this,\r\n            gl = glsl.gl;\r\n        if (glsl.buffers && Object.keys(glsl.buffers).length > 0) {\r\n            var i = 0,\r\n                W = gl.canvas.width,\r\n                H = gl.canvas.height;\r\n            gl.viewport(0, 0, W, H);\r\n            for (var key in glsl.buffers) {\r\n                var buffer = glsl.buffers[key];\r\n                buffer.bundle.resize(W, H, buffer.program, buffer.name);\r\n                /*\r\n                gl.useProgram(buffer.program);\r\n                //\r\n                gl.activeTexture(gl.TEXTURE0 + i * 2);\r\n                gl.bindTexture(gl.TEXTURE_2D, buffer.bundle.textureOut);\r\n                gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, W, H, 0, gl.RGBA, gl.UNSIGNED_BYTE, null);\r\n                //\r\n                gl.activeTexture(gl.TEXTURE0 + i * 2 + 1);\r\n                gl.bindTexture(gl.TEXTURE_2D, buffer.bundle.textureIn);\r\n                gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, W, H, 0, gl.RGBA, gl.UNSIGNED_BYTE, null);\r\n                */\r\n                i++;\r\n            }\r\n            gl.useProgram(glsl.program);\r\n        }\r\n    }\r\n\r\n    function setMouse(mouse) {\r\n        // _setMouse(mouse);\r\n        var glsl = this,\r\n            gl = glsl.gl;\r\n        var rect = this.canvas.getBoundingClientRect();\r\n        if (mouse && mouse.x && mouse.x >= rect.left && mouse.x <= rect.right && mouse.y && mouse.y >= rect.top && mouse.y <= rect.bottom) {\r\n            var x = mouse.x - rect.left;\r\n            var y = this.canvas.height - (mouse.y - rect.top);\r\n            // this.uniform('2f', 'vec2', 'u_mouse', x, y);\r\n            if (glsl.buffers && Object.keys(glsl.buffers).length > 0) {\r\n                for (var key in glsl.buffers) {\r\n                    var buffer = glsl.buffers[key];\r\n                    gl.useProgram(buffer.program);\r\n                    gl.uniform2f(gl.getUniformLocation(buffer.program, 'u_mouse'), x, y);\r\n                }\r\n            }\r\n            gl.useProgram(glsl.program);\r\n            gl.uniform2f(gl.getUniformLocation(glsl.program, 'u_mouse'), x, y);\r\n        }\r\n    }\r\n\r\n    function updateVariables() {\r\n        var glsl = this,\r\n            gl = glsl.gl;\r\n        var date = new Date();\r\n        var now = performance.now();\r\n        glsl.variables = glsl.variables || {};\r\n        glsl.variables.prev = glsl.variables.prev || now;\r\n        glsl.variables.delta = (now - glsl.variables.prev) / 1000.0;\r\n        glsl.variables.prev = now;\r\n        glsl.variables.load = glsl.timeLoad;\r\n        glsl.variables.time = (now - glsl.timeLoad) / 1000.0;\r\n        glsl.variables.year = date.getFullYear();\r\n        glsl.variables.month = date.getMonth();\r\n        glsl.variables.date = date.getDate();\r\n        glsl.variables.daytime = date.getHours() * 3600 + date.getMinutes() * 60 + date.getSeconds() + date.getMilliseconds() * 0.001;\r\n    }\r\n\r\n    function UpdateUniforms(program, key) {\r\n        var glsl = this,\r\n            gl = glsl.gl;\r\n\r\n        gl.useProgram(program);\r\n\r\n        gl.uniform2f(gl.getUniformLocation(program, 'u_resolution'), glsl.canvas.width, glsl.canvas.height);\r\n\r\n        if (glsl.nTime > 1) {\r\n            gl.uniform1f(gl.getUniformLocation(program, 'u_time'), glsl.variables.time);\r\n        }\r\n\r\n        if (glsl.nDelta > 1) {\r\n            gl.uniform1f(gl.getUniformLocation(program, 'u_delta'), glsl.variables.delta);\r\n        }\r\n\r\n        if (glsl.nDate) {\r\n            // Set date uniform: year/month/day/time_in_sec\r\n            gl.uniform4f(gl.getUniformLocation(program, 'u_date'), glsl.variables.year, glsl.variables.month, glsl.variables.date, glsl.variables.daytime);\r\n        }\r\n\r\n        /*\r\n        glsl.texureIndex = 0;\r\n        for (var key in glsl.textures) {\r\n            glsl.uniformTexture(key, {\r\n                filtering: 'mipmap',\r\n                repeat: true,\r\n            });\r\n        }\r\n        */\r\n\r\n        for (var key in glsl.buffers) {\r\n            var buffer = glsl.buffers[key];\r\n            gl.uniform1i(gl.getUniformLocation(program, buffer.name), buffer.bundle.input.index);\r\n        }\r\n\r\n        /*\r\n        var i = 0;\r\n        for (var key in glsl.buffers) {\r\n            program.buffers = program.buffers || {};\r\n            if (!program.buffers[\"u_buffer_\" + i]) {\r\n                program.buffers[\"u_buffer_\" + i] = true;\r\n                gl.uniform1i(gl.getUniformLocation(program, \"u_buffer_\" + i), i * 2 + 1);\r\n            }\r\n            i++;\r\n        }\r\n        */\r\n\r\n        /*\r\n        var i = 0,\r\n            au = gl.getProgramParameter(program, gl.ACTIVE_UNIFORMS);\r\n        while (i < au) {\r\n            var info = gl.getActiveUniform(program, i);\r\n            console.log('info', key, info);\r\n            i++;\r\n        }\r\n        console.log('status', key, 'link', gl.getProgramParameter(program, gl.LINK_STATUS), 'validate', gl.getProgramParameter(program, gl.VALIDATE_STATUS));\r\n        */\r\n\r\n        // console.log(key, 'u_time', u_time.location);\r\n\r\n    }\r\n\r\n    function createBuffer(W, H, program) {\r\n        var glsl = this,\r\n            gl = glsl.gl,\r\n            index = glsl.TEXTURE_COUNT + glsl.BUFFER_COUNT;\r\n        glsl.BUFFER_COUNT++;\r\n        var float_texture_ext = gl.getExtension('OES_texture_float');\r\n        var texture = gl.createTexture();\r\n        gl.activeTexture(gl.TEXTURE0 + index);\r\n        gl.bindTexture(gl.TEXTURE_2D, texture);\r\n        gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, W, H, 0, gl.RGBA, gl.FLOAT, null);\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\r\n        var buffer = gl.createFramebuffer();\r\n        // console.log('createBuffer', index);\r\n        return {\r\n            index: index,\r\n            texture: texture,\r\n            buffer: buffer,\r\n            resize: resize,\r\n            W: W,\r\n            H: H,\r\n        };\r\n\r\n        function resize(W, H) {\r\n            gl.bindFramebuffer(gl.FRAMEBUFFER, buffer);\r\n            var minW = Math.min(W, this.W);\r\n            var minH = Math.min(H, this.H);\r\n            var pixels = new Float32Array(minW * minH * 4);\r\n            gl.readPixels(0, 0, minW, minH, gl.RGBA, gl.FLOAT, pixels);\r\n            gl.bindFramebuffer(gl.FRAMEBUFFER, null);\r\n            // create new texture;\r\n            var newIndex = glsl.TEXTURE_COUNT + glsl.BUFFER_COUNT;\r\n            // glsl.BUFFER_COUNT++; // reuse index\r\n            var newTexture = gl.createTexture();\r\n            gl.activeTexture(gl.TEXTURE0 + newIndex);\r\n            gl.bindTexture(gl.TEXTURE_2D, newTexture);\r\n            gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, W, H, 0, gl.RGBA, gl.FLOAT, null);\r\n            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\r\n            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\r\n            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\r\n            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\r\n            // copy\r\n            gl.texSubImage2D(gl.TEXTURE_2D, 0, 0, 0, minW, minH, gl.RGBA, gl.FLOAT, pixels);\r\n            //\r\n            var newBuffer = gl.createFramebuffer();\r\n            //\r\n            gl.bindFramebuffer(gl.FRAMEBUFFER, null);\r\n            gl.deleteTexture(texture);\r\n            //\r\n            gl.activeTexture(gl.TEXTURE0 + index);\r\n            gl.bindTexture(gl.TEXTURE_2D, newTexture);\r\n            index = this.index = index;\r\n            texture = this.texture = newTexture;\r\n            buffer = this.buffer = newBuffer;\r\n            this.W = W;\r\n            this.H = H;\r\n            console.log(index, W, H);\r\n        }\r\n    }\r\n\r\n    function createSwappableBuffer(W, H, program) {\r\n        var glsl = this,\r\n            gl = glsl.gl;\r\n        var input = glsl.createBuffer(W, H, program);\r\n        var output = glsl.createBuffer(W, H, program);\r\n        return {\r\n            input: input,\r\n            output: output,\r\n            swap: function () {\r\n                var temp = input;\r\n                input = output;\r\n                output = temp;\r\n                this.input = input;\r\n                this.output = output;\r\n            },\r\n            render: function (W, H, program, name) {\r\n                gl.useProgram(program);\r\n                // gl.uniform1i(gl.getUniformLocation(program, name), input.index); // removable\r\n                gl.viewport(0, 0, W, H); // removable\r\n                gl.bindFramebuffer(gl.FRAMEBUFFER, input.buffer);\r\n                gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, output.texture, 0);\r\n                gl.drawArrays(gl.TRIANGLES, 0, 6);\r\n                this.swap();\r\n            },\r\n            resize: function (W, H, program, name) {\r\n                gl.useProgram(program);\r\n                gl.viewport(0, 0, W, H); // removable\r\n                this.input.resize(W, H);\r\n                this.output.resize(W, H);\r\n            },\r\n        };\r\n    }\r\n\r\n    function createShader(glsl, source, type, offset) {\r\n        var gl = glsl.gl;\r\n        var shader = gl.createShader(type);\r\n        gl.shaderSource(shader, source);\r\n        gl.compileShader(shader);\r\n        var compiled = gl.getShaderParameter(shader, gl.COMPILE_STATUS);\r\n        if (!compiled) {\r\n            var lastError = gl.getShaderInfoLog(shader);\r\n            console.log(lastError);\r\n            console.error('*** Error compiling shader ' + shader + ':' + lastError);\r\n            glsl.trigger('error', {\r\n                shader: shader,\r\n                source: source,\r\n                type: type,\r\n                error: lastError,\r\n                offset: offset || 0,\r\n            });\r\n            gl.deleteShader(shader);\r\n            return null;\r\n        }\r\n        return shader;\r\n    }\r\n\r\n    function createProgram(glsl, shaders, optAttribs, optLocations) {\r\n        var gl = glsl.gl;\r\n        var i;\r\n        var program = gl.createProgram();\r\n        for (i = 0; i < shaders.length; ++i) {\r\n            gl.attachShader(program, shaders[i]);\r\n        }\r\n        if (optAttribs) {\r\n            for (i = 0; i < optAttribs.length; ++i) {\r\n                gl.bindAttribLocation(program, optLocations ? optLocations[i] : i, optAttribs[i]);\r\n            }\r\n        }\r\n        gl.linkProgram(program);\r\n        var linked = gl.getProgramParameter(program, gl.LINK_STATUS);\r\n        if (!linked) {\r\n            var lastError = gl.getProgramInfoLog(program);\r\n            console.log('Error in program linking:' + lastError);\r\n            gl.deleteProgram(program);\r\n            return null;\r\n        }\r\n        /*\r\n        program.blit = function () {\r\n            gl.useProgram(program);\r\n            gl.bindBuffer(gl.ARRAY_BUFFER, gl.createBuffer());\r\n            gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([-1, -1, -1, 1, 1, 1, 1, -1]), gl.STATIC_DRAW);\r\n            gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, gl.createBuffer());\r\n            gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, new Uint16Array([0, 1, 2, 0, 2, 3]), gl.STATIC_DRAW);\r\n            gl.vertexAttribPointer(0, 2, gl.FLOAT, false, 0, 0);\r\n            gl.enableVertexAttribArray(0);\r\n            return function (destination) {\r\n                gl.useProgram(program);\r\n                gl.bindFramebuffer(gl.FRAMEBUFFER, destination);\r\n                // gl.drawElements(gl.TRIANGLES, 6, gl.UNSIGNED_SHORT, 0);\r\n                gl.drawArrays(gl.TRIANGLES, 0, 6);\r\n            };\r\n        }();\r\n        */\r\n        /*\r\n        var numAttribs = gl.getProgramParameter(program, gl.ACTIVE_ATTRIBUTES);\r\n        for (var i = 0; i < numAttribs; ++i) {\r\n            var attribInfo = gl.getActiveAttrib(program, i);\r\n            if (!attribInfo) {\r\n                break;\r\n            }\r\n            console.log(gl.getAttribLocation(program, attribInfo.name), attribInfo.name);\r\n        }\r\n        */\r\n        return program;\r\n    }\r\n\r\n    function isCanvasVisible(canvas) {\r\n        return ((canvas.getBoundingClientRect().top + canvas.height) > 0) && (canvas.getBoundingClientRect().top < (window.innerHeight || document.documentElement.clientHeight));\r\n    }\r\n\r\n    /*\r\n    function resizeSwappableBuffer(oldXres, oldYres) {\r\n        var needCopy = (oldXres !== null && oldYres !== null);\r\n        // first time!\r\n        if (!needCopy) {\r\n            var thumnailRes = [256, 128];\r\n            for (var i = 0; i < this.mMaxBuffers; i++) {\r\n                this.mBuffers[i] = {\r\n                    mTexture: [null, null],\r\n                    mTarget: [null, null],\r\n                    mLastRenderDone: 0,\r\n                    mThumbnailRenderTarget: null,//thumbnailRenderTarget,\r\n                    mThumbnailTexture: null,//thumbnailTexture,\r\n                    mThumbnailBuffer: null,//thumbnailBuffer,\r\n                    mThumbnailRes: thumnailRes\r\n                };\r\n            }\r\n        }\r\n\r\n        // Prepare for rendering\r\n        if (needCopy) {\r\n            var v = [0, 0, Math.min(this.mXres, oldXres), Math.min(this.mYres, oldYres)];\r\n            this.mRenderer.SetBlend(false);\r\n            this.mRenderer.SetViewport(v);\r\n            this.mRenderer.AttachShader(this.mProgramCopy);\r\n            var l1 = this.mRenderer.GetAttribLocation(this.mProgramCopy, \"pos\");\r\n            var vOld = [0, 0, oldXres, oldYres];\r\n            this.mRenderer.SetShaderConstant4FV(\"v\", vOld);\r\n        }\r\n\r\n        // Resize each double buffer\r\n        for (var i = 0; i < this.mMaxBuffers; i++) {\r\n            var texture1 = this.mRenderer.CreateTexture(this.mRenderer.TEXTYPE.T2D,\r\n                this.mXres, this.mYres,\r\n                this.mRenderer.TEXFMT.C4F32,\r\n                (needCopy) ? this.mBuffers[i].mTexture[0].mFilter : this.mRenderer.FILTER.NONE,\r\n                (needCopy) ? this.mBuffers[i].mTexture[0].mWrap : this.mRenderer.TEXWRP.CLAMP,\r\n                null);\r\n            var target1 = this.mRenderer.CreateRenderTarget(texture1, null, null, null, null, false);\r\n\r\n            var texture2 = this.mRenderer.CreateTexture(this.mRenderer.TEXTYPE.T2D,\r\n                this.mXres, this.mYres,\r\n                this.mRenderer.TEXFMT.C4F32,\r\n                (needCopy) ? this.mBuffers[i].mTexture[1].mFilter : this.mRenderer.FILTER.NONE,\r\n                (needCopy) ? this.mBuffers[i].mTexture[1].mWrap : this.mRenderer.TEXWRP.CLAMP,\r\n                null);\r\n\r\n            var target2 = this.mRenderer.CreateRenderTarget(texture2, null, null, null, null, false);\r\n\r\n            if (needCopy) {\r\n                // Copy old buffers 1 to new buffer\r\n                this.mRenderer.SetRenderTarget(target1);\r\n                this.mRenderer.AttachTextures(1, this.mBuffers[i].mTexture[0], null, null, null);\r\n                this.mRenderer.DrawUnitQuad_XY(l1);\r\n\r\n                // Copy old buffers 2 to new buffer\r\n                this.mRenderer.SetRenderTarget(target2);\r\n                this.mRenderer.AttachTextures(1, this.mBuffers[i].mTexture[1], null, null, null);\r\n                this.mRenderer.DrawUnitQuad_XY(l1);\r\n\r\n                // Deallocate old memory\r\n                this.mRenderer.DestroyTexture(this.mBuffers[i].mTexture[0]);\r\n                this.mRenderer.DestroyRenderTarget(this.mBuffers[i].mTarget[0]);\r\n                this.mRenderer.DestroyTexture(this.mBuffers[i].mTexture[1]);\r\n                this.mRenderer.DestroyRenderTarget(this.mBuffers[i].mTarget[1]);\r\n                //this.mRenderer.DestroyTexture(this.mBuffers[i].thumbnailTexture);\r\n            }\r\n            // Store new buffers\r\n            this.mBuffers[i].mTexture = [texture1, texture2],\r\n                this.mBuffers[i].mTarget = [target1, target2],\r\n                this.mBuffers[i].mLastRenderDone = 0;\r\n        }\r\n\r\n        if (needCopy) {\r\n            this.mRenderer.DettachTextures();\r\n            this.mRenderer.DetachShader();\r\n            this.mRenderer.SetRenderTarget(null);\r\n        }\r\n\r\n    }\r\n\r\n    function CreateTexture(type, xres, yres, format, filter, wrap, buffer) {\r\n        var glsl = this,\r\n            gl = glsl.gl;\r\n        var LEN = gl.UNSIGNED_BYTE; // 16\r\n        // var LEN = gl.FLOAT; // 32;\r\n\r\n        var id = gl.createTexture();\r\n        var glFoTy = iFormatPI2GL(format);\r\n        var glWrap = gl.REPEAT;\r\n        if (wrap === me.TEXWRP.CLAMP) {\r\n            glWrap = gl.CLAMP_TO_EDGE;\r\n        }\r\n        if (type === me.TEXTYPE.T2D) {\r\n            gl.bindTexture(gl.TEXTURE_2D, id);\r\n            //if (buffer==null)\r\n            //gl.texStorage2D(gl.TEXTURE_2D, 0, gl.RGBA, xres, yres);\r\n            //else\r\n            gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, xres, yres, 0, gl.RGBA, LEN, buffer);\r\n            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, glWrap);\r\n            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, glWrap);\r\n            if (filter === me.FILTER.NONE) {\r\n                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\r\n                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\r\n            } else if (filter === me.FILTER.LINEAR) {\r\n                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\r\n                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\r\n            } else if (filter === me.FILTER.MIPMAP) {\r\n                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\r\n                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR_MIPMAP_LINEAR);\r\n                gl.generateMipmap(gl.TEXTURE_2D);\r\n            } else {\r\n                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\r\n                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST_MIPMAP_LINEAR);\r\n                gl.generateMipmap(gl.TEXTURE_2D);\r\n            }\r\n            gl.bindTexture(gl.TEXTURE_2D, null);\r\n        } else if (type === me.TEXTYPE.T3D) {\r\n            if (mIs20) {\r\n                gl.bindTexture(gl.TEXTURE_3D, id);\r\n                gl.texParameteri(gl.TEXTURE_3D, gl.TEXTURE_BASE_LEVEL, 0);\r\n                gl.texParameteri(gl.TEXTURE_3D, gl.TEXTURE_MAX_LEVEL, Math.log2(xres));\r\n                if (filter === me.FILTER.NONE) {\r\n                    gl.texParameteri(gl.TEXTURE_3D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\r\n                    gl.texParameteri(gl.TEXTURE_3D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\r\n                } else if (filter === me.FILTER.LINEAR) {\r\n                    gl.texParameteri(gl.TEXTURE_3D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\r\n                    gl.texParameteri(gl.TEXTURE_3D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\r\n                } else if (filter === me.FILTER.MIPMAP) {\r\n                    gl.texParameteri(gl.TEXTURE_3D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\r\n                    gl.texParameteri(gl.TEXTURE_3D, gl.TEXTURE_MIN_FILTER, gl.LINEAR_MIPMAP_LINEAR);\r\n                } else {\r\n                    gl.texParameteri(gl.TEXTURE_3D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\r\n                    gl.texParameteri(gl.TEXTURE_3D, gl.TEXTURE_MIN_FILTER, gl.NEAREST_MIPMAP_LINEAR);\r\n                    gl.generateMipmap(gl.TEXTURE_3D);\r\n                }\r\n                gl.texImage3D(gl.TEXTURE_3D, 0, gl.RGBA, xres, yres, yres, 0, gl.RGBA, LEN, buffer);\r\n                gl.texParameteri(gl.TEXTURE_3D, gl.TEXTURE_WRAP_R, glWrap);\r\n                gl.texParameteri(gl.TEXTURE_3D, gl.TEXTURE_WRAP_S, glWrap);\r\n                gl.texParameteri(gl.TEXTURE_3D, gl.TEXTURE_WRAP_T, glWrap);\r\n                if (filter === me.FILTER.MIPMAP) {\r\n                    gl.generateMipmap(gl.TEXTURE_3D);\r\n                }\r\n                gl.bindTexture(gl.TEXTURE_3D, null);\r\n            } else {\r\n                return null;\r\n            }\r\n        } else {\r\n            gl.bindTexture(gl.TEXTURE_CUBE_MAP, id);\r\n            gl.texParameteri(gl.TEXTURE_CUBE_MAP, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\r\n            gl.texParameteri(gl.TEXTURE_CUBE_MAP, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\r\n            gl.bindTexture(gl.TEXTURE_CUBE_MAP, null);\r\n        }\r\n        return { mObjectID: id, mXres: xres, mYres: yres, mFormat: format, mType: type, mFilter: filter, mWrap: wrap, mVFlip: false };\r\n    };\r\n\r\n    function CreateRenderTarget(color0, color1, color2, color3, depth, wantZbuffer) {\r\n        var id = gl.createFramebuffer();\r\n        gl.bindFramebuffer(gl.FRAMEBUFFER, id);\r\n        if (depth === null) {\r\n            if (wantZbuffer === true) {\r\n                var zb = gl.createRenderbuffer();\r\n                gl.bindRenderbuffer(gl.RENDERBUFFER, zb);\r\n                gl.renderbufferStorage(gl.RENDERBUFFER, gl.DEPTH_COMPONENT16, color0.mXres, color0.mYres);\r\n\r\n                gl.framebufferRenderbuffer(gl.FRAMEBUFFER, gl.DEPTH_ATTACHMENT, gl.RENDERBUFFER, zb);\r\n            }\r\n        } else {\r\n            gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.DEPTH_ATTACHMENT, gl.TEXTURE_2D, depth.mObjectID, 0);\r\n        }\r\n        if (color0 != null) gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, color0.mObjectID, 0);\r\n        if (gl.checkFramebufferStatus(gl.FRAMEBUFFER) != gl.FRAMEBUFFER_COMPLETE) {\r\n            return null;\r\n        }\r\n        gl.bindRenderbuffer(gl.RENDERBUFFER, null);\r\n        gl.bindFramebuffer(gl.FRAMEBUFFER, null);\r\n        return {\r\n            mObjectID: id\r\n        };\r\n    }\r\n    */\r\n\r\n    window.CanvasService = CanvasService;\r\n}());\n/* global window, document, console, CanvasService, GlslCanvas, CaptureService, GuiService, TrailsService, CameraService, Stats, dat, JSZip, saveAs, Promise */\r\n\r\n(function () {\r\n    'use strict';\r\n\r\n    var options = window.options = {\r\n        vertex: '',\r\n        fragment: '',\r\n        main: '',\r\n        buffers: {},\r\n    };\r\n\r\n    function onLoad() {\r\n        getResource(\"shaders/buffers/milk.glsl\", function (fragment) {\r\n            var source = fragment;\r\n            var offset;\r\n            options.main = null;\r\n            // (?<=\\/{2} u_buffer_)(\\d+).*((.|\\n)*?)(?=\\/{2} [u_buffer|main]|\\z)\r\n            // (?<=\\/{2} main).*((.|\\n)*?)(?=\\/{2} u_buffer|\\z)\r\n            fragment = fragment.replace(new RegExp('(/{2} u_buffer_)(\\\\d+).*((.|[\\\\r\\\\n]+)*?)(?=/{2} u_buffer|/{2} main|$)', 'g'), function (match, name, i, fragment, end, offset) {\r\n                // console.log('u_buffer_.replace', arguments);\r\n                offset = source.substr(0, offset).split('\\n').length;\r\n                // console.log('offset', offset);\r\n                options.buffers['u_buffer_' + i] = {\r\n                    fragment: fragment,\r\n                    offset: offset,\r\n                };\r\n                return '';\r\n            });\r\n\r\n            fragment = fragment.replace(new RegExp('(/{2} main).*((.|[\\\\r\\\\n]+)*)(?=/{2} u_buffer|$)', 'g'), function (match, name, main, end, offset) {\r\n                options.main = main;\r\n                return '';\r\n            });\r\n\r\n            var linediff = fragment.split('\\n').length;\r\n\r\n            offset = 0;\r\n            if (options.main) {\r\n                source.replace(new RegExp('(/{2} main).*((.|[\\\\r\\\\n]+)*)(?=/{2} u_buffer|$)', 'g'), function (match, name, main, end, offset) {\r\n                    // console.log('main.replace', arguments);\r\n                    offset = source.substr(0, offset).split('\\n').length - linediff;\r\n                    return '';\r\n                });\r\n            }\r\n\r\n            // console.log('getResource', fragment, options.buffers);\r\n            for (var key in options.buffers) {\r\n                options.buffers[key].common = fragment;\r\n                options.buffers[key].offset -= linediff;\r\n            }\r\n\r\n            options.fragment = fragment + (options.main || '');\r\n            options.offset = offset;\r\n            // console.log('fragment', options.fragment);\r\n            createCanvas();\r\n        });\r\n    }\r\n\r\n    function createCanvas() {\r\n        var content = document.querySelector('.content');\r\n        var canvas = document.querySelector('.shader');\r\n        var btnDownload = document.querySelector('.btn-download');\r\n\r\n        resize(true);\r\n\r\n        var glsl = new CanvasService(canvas, {\r\n            premultipliedAlpha: false,\r\n            preserveDrawingBuffer: true,\r\n            backgroundColor: 'rgba(1,1,1,1)',\r\n        });\r\n        glsl.on('error', onGlslError);\r\n        glsl.on('render', function () {\r\n            // glsl.forceRender = true;\r\n        });\r\n\r\n        load();\r\n\r\n        function load() {\r\n            var options = window.options;\r\n            document.querySelector('.errors').setAttribute('class', 'errors');\r\n            document.querySelector('.welcome').setAttribute('class', 'welcome');\r\n            options.vertex = options.vertex.trim().length > 0 ? options.vertex : null;\r\n            options.fragment = options.fragment.trim().length > 0 ? options.fragment : null;\r\n            if (options.fragment || options.vertex) {\r\n                document.querySelector('body').setAttribute('class', 'ready');\r\n            } else {\r\n                document.querySelector('body').setAttribute('class', 'empty');\r\n            }\r\n            glsl.load(options.fragment, options.vertex, options.offset);\r\n            glsl.loadPrograms(options.buffers);\r\n            glsl.loadUniforms(options);\r\n            // console.log('glsl', glsl);\r\n            /*\r\n            gui.load(options.uniforms);\r\n            glsl.setUniforms(gui.uniforms());\r\n            */\r\n        }\r\n\r\n        function resize(init) {\r\n            var w = content.offsetWidth;\r\n            var h = content.offsetHeight;\r\n            canvas.style.width = w + 'px';\r\n            canvas.style.height = h + 'px';\r\n            if (init) {\r\n                canvas.width = w;\r\n                canvas.height = h;\r\n            } else {\r\n                glsl.resize();\r\n            }\r\n        }\r\n\r\n        var ri;\r\n\r\n        function onResize() {\r\n            if (ri) {\r\n                clearTimeout(ri);\r\n            }\r\n            ri = setTimeout(resize, 50);\r\n        }\r\n\r\n        function onDownload() {\r\n            var urls = [\r\n                \"css/app.css\",\r\n                \"css/app.min.css\",\r\n                \"css/vendors.css\",\r\n                \"css/vendors.min.css\",\r\n                \"js/app.js\",\r\n                \"js/app.min.js\",\r\n                \"js/vendors.js\",\r\n                \"js/vendors.min.js\",\r\n                \"shaders/buffers/milk.glsl\",\r\n                \"index.html\",\r\n            ];\r\n            var zip = new JSZip();\r\n            Promise.all(urls.map(function (url) {\r\n                return new Promise(function (resolve) {\r\n                    var request = new XMLHttpRequest();\r\n                    request.open(\"GET\", url);\r\n                    request.onload = function () {\r\n                        zip.file(url, this.responseText);\r\n                        resolve();\r\n                    };\r\n                    request.send();\r\n                });\r\n            })).then(function () {\r\n                console.log(zip);\r\n                zip.generateAsync({\r\n                    type: \"blob\"\r\n                }).then(function (content) {\r\n                    /*\r\n                    var a = document.querySelector(\"a\");\r\n                    a.download = \"folder\" + new Date().getTime();\r\n                    a.href = URL.createObjectURL(content);\r\n                    a.innerHTML = \"download \" + a.download;\r\n                    */\r\n                    saveAs(content, \"glsl-canvas.zip\");\r\n                });\r\n            });\r\n        }\r\n\r\n        btnDownload.addEventListener('click', onDownload);\r\n        window.addEventListener('resize', onResize);\r\n\r\n        resize();\r\n    }\r\n\r\n    function onGlslError(message) {\r\n        console.log('onGlslError.error', message);\r\n        var options = window.options;\r\n        var errors = [],\r\n            warnings = [];\r\n        message.error.replace(/ERROR: \\d+:(\\d+): \\'(.+)\\' : (.+)/g, function (m, l, v, t) {\r\n            var line = Number(l) + message.offset;\r\n            var error = 'ERROR (' + v + ') ' + t;\r\n            var li = '<li><a class=\"error\" unselectable href=\"' + encodeURI('command:glsl-canvas.revealGlslLine?' + JSON.stringify([options.uri, line, error])) + '\"><span class=\"line\">ERROR line ' + line + '</span> <span class=\"value\" title=\"' + v + '\">' + v + '</span> <span class=\"text\" title=\"' + t + '\">' + t + '</span></a></li>';\r\n            errors.push(li);\r\n            return li;\r\n        });\r\n        message.error.replace(/WARNING: \\d+:(\\d+): \\'(.*\\n*|.*|\\n*)\\' : (.+)/g, function (m, l, v, t) {\r\n            var line = Number(l) + message.offset;\r\n            var warning = 'WARNING (' + v + ') ' + t;\r\n            var li = '<li><a class=\"warning\" unselectable href=\"' + encodeURI('command:glsl-canvas.revealGlslLine?' + JSON.stringify([options.uri, line, warning])) + '\"><span class=\"line\">WARN line ' + line + '</span> <span class=\"text\" title=\"' + t + '\">' + t + '</span></a></li>';\r\n            warnings.push(li);\r\n            return li;\r\n        });\r\n        var output = '<div class=\"errors-content\"><p>glslCanvas error</p><ul>';\r\n        output += errors.join('\\n');\r\n        output += warnings.join('\\n');\r\n        output += '</ul></div>';\r\n        document.querySelector('.errors').setAttribute('class', 'errors active');\r\n        document.querySelector('.errors').innerHTML = output;\r\n        document.querySelector('body').setAttribute('class', 'idle');\r\n    }\r\n\r\n    function getResource(url, callback) {\r\n        var request = new XMLHttpRequest();\r\n        request.open('GET', url, true);\r\n        request.addEventListener('load', function () {\r\n            callback(request.responseText);\r\n        });\r\n        request.send();\r\n    }\r\n\r\n    window.addEventListener('load', onLoad);\r\n\r\n}());"]}