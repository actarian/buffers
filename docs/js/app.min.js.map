{"version":3,"sources":["docs/js/app.js"],"names":["GlslCanvasWrapper","createShader","glsl","source","type","gl","shader","shaderSource","compileShader","getShaderParameter","COMPILE_STATUS","lastError","getShaderInfoLog","console","error","trigger","deleteShader","createProgram","shaders","optAttribs","optLocations","i","program","length","attachShader","bindAttribLocation","linkProgram","getProgramParameter","LINK_STATUS","getProgramInfoLog","log","deleteProgram","GlslCanvas","prototype","loadBuffers","buffers","this","bundle","W","H","useProgram","texture","createTexture","buffer","createFramebuffer","bindTexture","TEXTURE_2D","texImage2D","RGBA","UNSIGNED_BYTE","texParameteri","TEXTURE_MIN_FILTER","NEAREST","TEXTURE_MAG_FILTER","TEXTURE_WRAP_S","CLAMP_TO_EDGE","TEXTURE_WRAP_T","draw","bindFramebuffer","FRAMEBUFFER","framebufferTexture2D","COLOR_ATTACHMENT0","viewport","activeTexture","TEXTURE0","drawArrays","TRIANGLES","vertex","vertexString","VERTEX_SHADER","key","fragment","common","FRAGMENT_SHADER","isValid","canvas","width","height","loadUniforms","options","textures","uniformTexture","filtering","repeat","updateVariables","date","Date","now","performance","variables","prev","delta","load","timeLoad","time","year","getFullYear","month","getMonth","getDate","daytime","getHours","getMinutes","getSeconds","getMilliseconds","updateUniforms","uniform1f","getUniformLocation","uniform2f","p","uniform1i","updateBuffers","Object","keys","render","visible","getBoundingClientRect","top","window","innerHeight","document","documentElement","clientHeight","animated","forceRender","paused","change","main","onGlslError","message","errors","warnings","replace","m","l","v","t","li","encodeURI","JSON","stringify","uri","Number","push","output","join","querySelector","setAttribute","innerHTML","addEventListener","url","callback","request","RegExp","match","name","content","resize","ri","premultipliedAlpha","preserveDrawingBuffer","backgroundColor","init","w","offsetWidth","h","offsetHeight","style","on","trim","clearTimeout","setTimeout","createCanvas","XMLHttpRequest","open","responseText","send"],"mappings":"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","file":"app.min.js","sourcesContent":["/* global window, document, console, GlslCanvas, CaptureService, GuiService, TrailsService, CameraService, Stats, dat */\n\n(function () {\n    'use strict';\n\n    var GlslCanvasWrapper = function () {\n\n        function GlslCanvasWrapper(canvas, options) {\n            return new GlslCanvas(canvas, options);\n        }\n\n        GlslCanvas.prototype.loadBuffers = loadBuffers;\n        GlslCanvas.prototype.loadUniforms = loadUniforms;\n        GlslCanvas.prototype.updateVariables = updateVariables;\n        GlslCanvas.prototype.updateUniforms = updateUniforms;\n        GlslCanvas.prototype.updateBuffers = updateBuffers;\n        GlslCanvas.prototype.render = render;\n        // GlslCanvas.prototype.uniform = uniform;\n\n        function loadBuffers(buffers) {\n            var glsl = this,\n                gl = glsl.gl,\n                i = 0;\n            glsl.buffers = {};\n            gl.bundle = function (program, i, W, H) {\n                gl.useProgram(program);\n                var texture = gl.createTexture();\n                var buffer = gl.createFramebuffer();\n                gl.bindTexture(gl.TEXTURE_2D, texture);\n                gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, W, H, 0, gl.RGBA, gl.UNSIGNED_BYTE, null);\n                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\n                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\n                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\n                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\n                return {\n                    texture: texture,\n                    buffer: buffer,\n                    draw: function () {\n                        gl.useProgram(program);\n                        gl.bindFramebuffer(gl.FRAMEBUFFER, buffer);\n                        gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, texture, 0);\n                        gl.viewport(0, 0, W, H);\n                        gl.activeTexture(gl.TEXTURE0 + i);\n                        gl.bindTexture(gl.TEXTURE_2D, texture);\n                        // gl.drawElements(gl.TRIANGLES, 6, gl.UNSIGNED_BYTE, 0);\n                        gl.drawArrays(gl.TRIANGLES, 0, 6);\n                        // gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, 1, 1, 0, gl.RGBA, gl.UNSIGNED_BYTE, null);\n                    }\n                };\n            };\n\n            var vertex = createShader(glsl, glsl.vertexString, gl.VERTEX_SHADER);\n            for (var key in buffers) {\n                var buffer = buffers[key];\n                var fragment = createShader(glsl, buffer.common + buffer.fragment, gl.FRAGMENT_SHADER);\n                if (!fragment) {\n                    fragment = createShader(glsl, 'void main(){\\n\\tgl_FragColor = vec4(1.0);\\n}', gl.FRAGMENT_SHADER);\n                    glsl.isValid = false;\n                } else {\n                    glsl.isValid = true;\n                }\n                var program = createProgram(glsl, [vertex, fragment]);\n                buffer.program = program;\n                buffer.bundle = gl.bundle(program, i, glsl.canvas.width, glsl.canvas.height);\n                // console.log(i, key, buffer.common + buffer.fragment, buffer.bundle);\n                glsl.buffers[key] = buffer;\n                gl.deleteShader(fragment);\n                i++;\n            }\n            gl.deleteShader(vertex);\n        }\n\n        function loadUniforms(options) {\n            if (options.textures) {\n                for (var key in options.textures) {\n                    glsl.uniformTexture('u_texture_' + key, options.textures[key], {\n                        filtering: 'mipmap',\n                        repeat: true,\n                    });\n                }\n            }\n        }\n\n        function updateVariables() {\n            var glsl = this,\n                gl = glsl.gl;\n            var date = new Date();\n            var now = performance.now();\n            glsl.variables = glsl.variables || {};\n            glsl.variables.prev = glsl.variables.prev || now;\n            glsl.variables.delta = (now - glsl.variables.prev) / 1000.0;\n            glsl.variables.prev = now;\n            glsl.variables.load = glsl.timeLoad;\n            glsl.variables.time = (now - glsl.timeLoad) / 1000.0;\n            glsl.variables.year = date.getFullYear();\n            glsl.variables.month = date.getMonth();\n            glsl.variables.date = date.getDate();\n            glsl.variables.daytime = date.getHours() * 3600 + date.getMinutes() * 60 + date.getSeconds() + date.getMilliseconds() * 0.001;\n        }\n\n        function updateUniforms(program, key) {\n            var glsl = this,\n                gl = glsl.gl;\n\n            /*\n            // if (glsl.nDelta > 1) {\n            glsl.uniform(program, '1f', 'float', 'u_delta', glsl.variables.delta);\n            // }\n            */\n\n            // if (glsl.nTime > 1) {\n            gl.uniform1f(gl.getUniformLocation(program, 'u_time'), glsl.variables.time);\n            // }\n\n            /*\n            // if (glsl.nDate) {\n            // Set date uniform: year/month/day/time_in_sec\n            glsl.uniform(program, '4f', 'float', 'u_date', glsl.variables.year, glsl.variables.month, glsl.variables.date, glsl.variables.daytime);\n            // }\n            */\n            gl.uniform2f(gl.getUniformLocation(program, 'u_resolution'), glsl.canvas.width, glsl.canvas.height);\n\n            var i = 0;\n            for (var p in glsl.buffers) {\n                program.buffers = program.buffers || {};\n                if (!program.buffers[\"u_buffer_\" + i]) {\n                    program.buffers[\"u_buffer_\" + i] = true;\n                    gl.uniform1i(gl.getUniformLocation(program, \"u_buffer_\" + i), i);\n                }\n                i++;\n            }\n\n            /*\n            glsl.texureIndex = 0;\n            for (var key in glsl.textures) {\n                glsl.uniformTexture(key, {\n                    filtering: 'mipmap',\n                    repeat: true,\n                });\n            }\n            */\n\n            /*\n            var i = 0,\n                au = gl.getProgramParameter(program, gl.ACTIVE_UNIFORMS);\n            while (i < au) {\n                var info = gl.getActiveUniform(program, i);\n                console.log('info', key, info);\n                i++;\n            }\n            console.log('status', key, 'link', gl.getProgramParameter(program, gl.LINK_STATUS), 'validate', gl.getProgramParameter(program, gl.VALIDATE_STATUS));\n            */\n\n            // console.log(key, 'u_time', u_time.location);\n\n        }\n\n        /*\n        function uniform(program, method, type, name) {\n            var glsl = this,\n                gl = glsl.gl;\n            var value = Array.prototype.slice.call(arguments).slice(3);\n            glsl.uniforms = glsl.uniforms || {};\n            glsl.uniforms[name] = glsl.uniforms[name] || {};\n            var uniform = glsl.uniforms[name];\n            var change = true; // isDiff(uniform.value, value);\n            if (change || glsl.change || uniform.location === undefined || uniform.value === undefined) {\n                uniform.name = name;\n                uniform.value = value;\n                uniform.type = type;\n                uniform.method = 'uniform' + method;\n                uniform.location = gl.getUniformLocation(program, name);\n                gl[uniform.method].apply(gl, [uniform.location].concat(uniform.value));\n            }\n            return uniform;\n        }   \n        */\n\n        function updateBuffers() {\n            var glsl = this,\n                gl = glsl.gl;\n            if (glsl.buffers && Object.keys(glsl.buffers).length > 0) {\n                for (var key in glsl.buffers) {\n                    var buffer = glsl.buffers[key];\n                    gl.useProgram(buffer.program);\n                    glsl.updateUniforms(buffer.program, key);\n                    buffer.bundle.draw();\n                }\n                gl.useProgram(glsl.program);\n                glsl.updateUniforms(glsl.program, 'main');\n                gl.bindFramebuffer(gl.FRAMEBUFFER, null);\n                gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);\n            }\n        }\n\n        function render() {\n            var glsl = this,\n                gl = glsl.gl;\n            glsl.visible = isCanvasVisible(glsl.canvas);\n            glsl.animated = true;\n            if (glsl.forceRender || (glsl.animated && glsl.visible && !glsl.paused)) {\n                glsl.updateVariables();\n                glsl.updateBuffers();\n                gl.drawArrays(gl.TRIANGLES, 0, 6);\n                glsl.trigger('render', {});\n                glsl.change = false;\n                glsl.forceRender = false;\n            }\n        }\n\n        function createShader(glsl, source, type) {\n            var gl = glsl.gl;\n            var shader = gl.createShader(type);\n            gl.shaderSource(shader, source);\n            gl.compileShader(shader);\n            var compiled = gl.getShaderParameter(shader, gl.COMPILE_STATUS);\n            if (!compiled) {\n                var lastError = gl.getShaderInfoLog(shader);\n                console.error('*** Error compiling shader ' + shader + ':' + lastError);\n                glsl.trigger('error', {\n                    shader: shader,\n                    source: source,\n                    type: type,\n                    error: lastError\n                });\n                gl.deleteShader(shader);\n                return null;\n            }\n            return shader;\n        }\n\n        function createProgram(glsl, shaders, optAttribs, optLocations) {\n            var gl = glsl.gl;\n            var i;\n            var program = gl.createProgram();\n            for (i = 0; i < shaders.length; ++i) {\n                gl.attachShader(program, shaders[i]);\n            }\n            if (optAttribs) {\n                for (i = 0; i < optAttribs.length; ++i) {\n                    gl.bindAttribLocation(program, optLocations ? optLocations[i] : i, optAttribs[i]);\n                }\n            }\n            gl.linkProgram(program);\n            var linked = gl.getProgramParameter(program, gl.LINK_STATUS);\n            if (!linked) {\n                var lastError = gl.getProgramInfoLog(program);\n                console.log('Error in program linking:' + lastError);\n                gl.deleteProgram(program);\n                return null;\n            }\n            return program;\n        }\n\n        function isCanvasVisible(canvas) {\n            return ((canvas.getBoundingClientRect().top + canvas.height) > 0) && (canvas.getBoundingClientRect().top < (window.innerHeight || document.documentElement.clientHeight));\n        }\n\n        return GlslCanvasWrapper;\n\n    }();\n\n    var options = window.options = {\n        vertex: '',\n        fragment: '',\n        main: '',\n        buffers: {},\n    };\n\n    function init() {\n        getResource(\"shaders/buffers/milk.glsl\", function (fragment) {\n            // (?<=\\/{2} u_buffer_)(\\d+).*((.|\\n)*?)(?=\\/{2} [u_buffer|main]|\\z)\n            // (?<=\\/{2} main).*((.|\\n)*?)(?=\\/{2} u_buffer|\\z)\n            fragment = fragment.replace(new RegExp('(/{2} u_buffer_)(\\\\d+).*((.|\\\\n)*?)(?=/{2} u_buffer|/{2} main|$)', 'g'), function (match, name, i, fragment) {\n                // console.log('u_buffer_.replace', arguments);\n                options.buffers['u_buffer_' + i] = {\n                    fragment: fragment,\n                };\n                return '';\n            });\n\n            fragment = fragment.replace(new RegExp('(/{2} main).*((.|\\\\n)*)(?=/{2} u_buffer|$)', 'g'), function (match, name, main) {\n                options.main = main;\n                return '';\n            });\n\n            // console.log('getResource', fragment, options.buffers);\n            for (var key in options.buffers) {\n                options.buffers[key].common = fragment;\n            }\n\n            options.fragment = fragment + (options.main || '');\n            // console.log('fragment', options.fragment);\n            createCanvas();\n        });\n    }\n\n    function createCanvas() {\n        var content = document.querySelector('.content');\n        var canvas = document.querySelector('.shader');\n\n        resize(true);\n\n        var glsl = new GlslCanvasWrapper(canvas, {\n            premultipliedAlpha: false,\n            preserveDrawingBuffer: true,\n            backgroundColor: 'rgba(1,1,1,1)',\n        });\n        glsl.animated = true;\n        glsl.on('error', onGlslError);\n        glsl.on('render', function () {\n            glsl.forceRender = true;\n        });\n\n        load();\n\n        function load() {\n            var options = window.options;\n            document.querySelector('.errors').setAttribute('class', 'errors');\n            document.querySelector('.welcome').setAttribute('class', 'welcome');\n            options.vertex = options.vertex.trim().length > 0 ? options.vertex : null;\n            options.fragment = options.fragment.trim().length > 0 ? options.fragment : null;\n            if (options.fragment || options.vertex) {\n                document.querySelector('body').setAttribute('class', 'ready');\n            } else {\n                document.querySelector('body').setAttribute('class', 'empty');\n            }\n            glsl.load(options.fragment, options.vertex);\n            glsl.loadBuffers(options.buffers);\n            glsl.loadUniforms(options);\n\n            // console.log('glsl', glsl);\n            /*\n            gui.load(options.uniforms);\n            glsl.setUniforms(gui.uniforms());\n            */\n        }\n\n        function resize(init) {\n            var w = content.offsetWidth;\n            var h = content.offsetHeight;\n            canvas.style.width = w + 'px';\n            canvas.style.height = h + 'px';\n            if (init) {\n                canvas.width = w;\n                canvas.height = h;\n            } else {\n                glsl.resize();\n            }\n        }\n\n        var ri;\n\n        function onResize() {\n            if (ri) {\n                clearTimeout(ri);\n            }\n            ri = setTimeout(resize, 50);\n        }\n\n        window.addEventListener('resize', onResize);\n\n        resize();\n    }\n\n    function onGlslError(message) {\n        console.log('onGlslError.error', message.error);\n        var options = window.options;\n        var errors = [],\n            warnings = [];\n        message.error.replace(/ERROR: \\d+:(\\d+): \\'(.+)\\' : (.+)/g, function (m, l, v, t) {\n            var message = 'ERROR (' + v + ') ' + t;\n            var li = '<li><a class=\"error\" unselectable href=\"' + encodeURI('command:glsl-canvas.revealGlslLine?' + JSON.stringify([options.uri, Number(l), message])) + '\"><span class=\"line\">ERROR line ' + Number(l) + '</span> <span class=\"value\" title=\"' + v + '\">' + v + '</span> <span class=\"text\" title=\"' + t + '\">' + t + '</span></a></li>';\n            errors.push(li);\n            return li;\n        });\n        message.error.replace(/WARNING: \\d+:(\\d+): \\'(.*\\n*|.*|\\n*)\\' : (.+)/g, function (m, l, v, t) {\n            var li = '<li><a class=\"warning\" unselectable href=\"' + encodeURI('command:glsl-canvas.revealGlslLine?' + JSON.stringify([options.uri, Number(l), message])) + '\"><span class=\"line\">WARN line ' + Number(l) + '</span> <span class=\"text\" title=\"' + t + '\">' + t + '</span></a></li>';\n            warnings.push(li);\n            return li;\n        });\n        var output = '<div class=\"errors-content\"><p>glslCanvas error</p><ul>';\n        output += errors.join('\\n');\n        output += warnings.join('\\n');\n        output += '</ul></div>';\n        document.querySelector('.errors').setAttribute('class', 'errors active');\n        document.querySelector('.errors').innerHTML = output;\n        document.querySelector('body').setAttribute('class', 'idle');\n    }\n\n    function getResource(url, callback) {\n        var request = new XMLHttpRequest();\n        request.open('GET', url, true);\n        request.addEventListener('load', function () {\n            callback(request.responseText);\n        });\n        request.send();\n    }\n\n    window.addEventListener('load', init);\n\n}());"]}