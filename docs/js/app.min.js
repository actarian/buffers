!function(){"use strict";GlslCanvas.prototype.TEXTURE_COUNT=0,GlslCanvas.prototype.BUFFER_COUNT=0,GlslCanvas.prototype.createBuffer=function(e,r,t){var l=this,u=l.gl,f=l.TEXTURE_COUNT+l.BUFFER_COUNT;l.BUFFER_COUNT++;u.getExtension("OES_texture_float");var c=u.createTexture();u.activeTexture(u.TEXTURE0+f),u.bindTexture(u.TEXTURE_2D,c),u.texImage2D(u.TEXTURE_2D,0,u.RGBA,e,r,0,u.RGBA,u.FLOAT,null),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MIN_FILTER,u.NEAREST),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MAG_FILTER,u.NEAREST),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_S,u.CLAMP_TO_EDGE),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_T,u.CLAMP_TO_EDGE);var m=u.createFramebuffer();return{index:f,texture:c,buffer:m,resize:function(e,r){u.bindFramebuffer(u.FRAMEBUFFER,m);var t=Math.min(e,this.W),a=Math.min(r,this.H),n=new Float32Array(t*a*4);u.readPixels(0,0,t,a,u.RGBA,u.FLOAT,n),u.bindFramebuffer(u.FRAMEBUFFER,null);var i=l.TEXTURE_COUNT+l.BUFFER_COUNT,s=u.createTexture();u.activeTexture(u.TEXTURE0+i),u.bindTexture(u.TEXTURE_2D,s),u.texImage2D(u.TEXTURE_2D,0,u.RGBA,e,r,0,u.RGBA,u.FLOAT,null),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MIN_FILTER,u.NEAREST),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MAG_FILTER,u.NEAREST),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_S,u.CLAMP_TO_EDGE),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_T,u.CLAMP_TO_EDGE),u.texSubImage2D(u.TEXTURE_2D,0,0,0,t,a,u.RGBA,u.FLOAT,n);var o=u.createFramebuffer();u.bindFramebuffer(u.FRAMEBUFFER,null),u.deleteTexture(c),u.activeTexture(u.TEXTURE0+f),u.bindTexture(u.TEXTURE_2D,s),f=this.index=f,c=this.texture=s,m=this.buffer=o,this.W=e,this.H=r,console.log(f,e,r)},W:e,H:r}},GlslCanvas.prototype.createSwappableBuffer=function(e,r,t){var n=this.gl,i=this.createBuffer(e,r,t),s=this.createBuffer(e,r,t);return{input:i,output:s,swap:function(){var e=i;i=s,s=e,this.input=i,this.output=s},render:function(e,r,t,a){n.useProgram(t),n.viewport(0,0,e,r),n.bindFramebuffer(n.FRAMEBUFFER,i.buffer),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,s.texture,0),n.drawArrays(n.TRIANGLES,0,6),this.swap()},resize:function(e,r,t,a){n.useProgram(t),n.viewport(0,0,e,r),this.input.resize(e,r),this.output.resize(e,r)}}},GlslCanvas.prototype.load=function(e,r){var t=this,a=t.gl;r&&(t.vertexString=r);e&&(t.fragmentString=e);if(t.animated=!1,t.nDelta=(t.fragmentString.match(/u_delta/g)||[]).length,t.nTime=(t.fragmentString.match(/u_time/g)||[]).length,t.nDate=(t.fragmentString.match(/u_date/g)||[]).length,t.nMouse=(t.fragmentString.match(/u_mouse/g)||[]).length,t.animated=1<t.nDate||1<t.nTime||1<t.nMouse,t.fragmentString.search(/sampler2D/g))for(var n=t.fragmentString.split("\n"),i=0;i<n.length;i++){var s=n[i].match(/uniform\s*sampler2D\s*([\w]*);\s*\/\/\s*([\w|\:\/\/|\.|\-|\_]*)/i);if(s){var o=s[2].split(".").pop().toLowerCase();s[1]&&s[2]&&("jpg"===o||"jpeg"===o||"png"===o||"ogv"===o||"webm"===o||"mp4"===o)&&t.setUniform(s[1],s[2])}var l=n[i].match(/\s*void\s*main\s*/g);if(l)break}var u=m(t,t.vertexString,a.VERTEX_SHADER),f=m(t,t.fragmentString,a.FRAGMENT_SHADER);f?t.isValid=!0:(f=m(t,"void main(){\n\tgl_FragColor = vec4(1.0);\n}",a.FRAGMENT_SHADER),t.isValid=!1);var c=g(t,[u,f]);a.useProgram(c),a.deleteShader(u),a.deleteShader(f),t.program=c,t.change=!0,t.trigger("load",{}),t.forceRender=!0},GlslCanvas.prototype.loadPrograms=function(e){var r=this,t=r.gl,a=0;r.buffers={};var n=m(r,r.vertexString,t.VERTEX_SHADER);for(var i in e){var s=e[i],o=m(r,s.common+s.fragment,t.FRAGMENT_SHADER,s.line);o?r.isValid=!0:(o=m(r,"void main(){\n\tgl_FragColor = vec4(1.0);\n}",t.FRAGMENT_SHADER),r.isValid=!1);var l=g(r,[n,o]);s.name="u_buffer_"+a,s.program=l,s.bundle=r.createSwappableBuffer(r.canvas.width,r.canvas.height,l),r.buffers[i]=s,t.deleteShader(o),a++}t.deleteShader(n)},GlslCanvas.prototype.loadUniforms=function(e){this.gl;if(e.textures)for(var r in e.textures)this.uniformTexture("u_texture_"+r,e.textures[r],{filtering:"mipmap",repeat:!0})},GlslCanvas.prototype.updateVariables=function(){var e=this,r=(e.gl,new Date),t=performance.now();e.variables=e.variables||{},e.variables.prev=e.variables.prev||t,e.variables.delta=(t-e.variables.prev)/1e3,e.variables.prev=t,e.variables.load=e.timeLoad,e.variables.time=(t-e.timeLoad)/1e3,e.variables.year=r.getFullYear(),e.variables.month=r.getMonth(),e.variables.date=r.getDate(),e.variables.daytime=3600*r.getHours()+60*r.getMinutes()+r.getSeconds()+.001*r.getMilliseconds()},GlslCanvas.prototype.UpdateUniforms=function(e,r){var t=this,a=t.gl;a.useProgram(e),a.uniform2f(a.getUniformLocation(e,"u_resolution"),t.canvas.width,t.canvas.height),1<t.nTime&&a.uniform1f(a.getUniformLocation(e,"u_time"),t.variables.time);1<t.nDelta&&a.uniform1f(a.getUniformLocation(e,"u_delta"),t.variables.delta);t.nDate&&a.uniform4f(a.getUniformLocation(e,"u_date"),t.variables.year,t.variables.month,t.variables.date,t.variables.daytime);for(var r in t.buffers){var n=t.buffers[r];a.uniform1i(a.getUniformLocation(e,n.name),n.bundle.input.index)}},GlslCanvas.prototype.resizeSwappableBuffers=function(){var e=this,r=e.gl;if(e.buffers&&0<Object.keys(e.buffers).length){var t=r.canvas.width,a=r.canvas.height;for(var n in r.viewport(0,0,t,a),e.buffers){var i=e.buffers[n];i.bundle.resize(t,a,i.program,i.name),0}r.useProgram(e.program)}},GlslCanvas.prototype.renderPrograms=function(){var e=this,r=e.gl,t=r.canvas.width,a=r.canvas.height;if(e.updateVariables(),r.viewport(0,0,t,a),e.buffers&&0<Object.keys(e.buffers).length){for(var n in e.buffers){var i=e.buffers[n];e.UpdateUniforms(i.program,n),i.bundle.render(t,a,i.program,i.name)}r.bindFramebuffer(r.FRAMEBUFFER,null)}e.UpdateUniforms(e.program,"main"),r.drawArrays(r.TRIANGLES,0,6)},GlslCanvas.prototype.render=function(){var e=this;e.gl;e.visible=(r=e.canvas,0<r.getBoundingClientRect().top+r.height&&r.getBoundingClientRect().top<(window.innerHeight||document.documentElement.clientHeight)),(e.forceRender||e.animated&&e.visible&&!e.paused)&&(e.renderPrograms(),e.change=!1,e.forceRender=!1,e.trigger("render",{}));var r};GlslCanvas.prototype.setMouse;GlslCanvas.prototype.setMouse=function(e){var r=this,t=r.gl,a=this.canvas.getBoundingClientRect();if(e&&e.x&&e.x>=a.left&&e.x<=a.right&&e.y&&e.y>=a.top&&e.y<=a.bottom){var n=e.x-a.left,i=this.canvas.height-(e.y-a.top);if(r.buffers&&0<Object.keys(r.buffers).length)for(var s in r.buffers){var o=r.buffers[s];t.useProgram(o.program),t.uniform2f(t.getUniformLocation(o.program,"u_mouse"),n,i)}t.useProgram(r.program),t.uniform2f(t.getUniformLocation(r.program,"u_mouse"),n,i)}};var r=GlslCanvas.prototype.resize;function m(e,r,t,a){var n=e.gl,i=n.createShader(t);if(n.shaderSource(i,r),n.compileShader(i),!n.getShaderParameter(i,n.COMPILE_STATUS)){var s=n.getShaderInfoLog(i);return console.log(s),console.error("*** Error compiling shader "+i+":"+s),e.trigger("error",{shader:i,source:r,type:t,error:s,offset:a||0}),n.deleteShader(i),null}return i}function g(e,r,t,a){var n,i=e.gl,s=i.createProgram();for(n=0;n<r.length;++n)i.attachShader(s,r[n]);if(t)for(n=0;n<t.length;++n)i.bindAttribLocation(s,a?a[n]:n,t[n]);if(i.linkProgram(s),!i.getProgramParameter(s,i.LINK_STATUS)){var o=i.getProgramInfoLog(s);return console.log("Error in program linking:"+o),i.deleteProgram(s),null}return s}GlslCanvas.prototype.resize=function(){var e=r.apply(this);e&&this.resizeSwappableBuffers();return e},window.CanvasService=function(e,r){return new GlslCanvas(e,r)}}(),function(){"use strict";var o=window.options={vertex:"",fragment:"",main:"",buffers:{}};function l(o){console.log("onGlslError.error",o);var l=window.options,u=[],f=[];o.error.replace(/ERROR: \d+:(\d+): \'(.+)\' : (.+)/g,function(e,r,t,a){var n=Number(r)+o.offset,i="ERROR ("+t+") "+a,s='<li><a class="error" unselectable href="'+encodeURI("command:glsl-canvas.revealGlslLine?"+JSON.stringify([l.uri,n,i]))+'"><span class="line">ERROR line '+n+'</span> <span class="value" title="'+t+'">'+t+'</span> <span class="text" title="'+a+'">'+a+"</span></a></li>";return u.push(s),s}),o.error.replace(/WARNING: \d+:(\d+): \'(.*\n*|.*|\n*)\' : (.+)/g,function(e,r,t,a){var n=Number(r)+o.offset,i="WARNING ("+t+") "+a,s='<li><a class="warning" unselectable href="'+encodeURI("command:glsl-canvas.revealGlslLine?"+JSON.stringify([l.uri,n,i]))+'"><span class="line">WARN line '+n+'</span> <span class="text" title="'+a+'">'+a+"</span></a></li>";return f.push(s),s});var e='<div class="errors-content"><p>glslCanvas error</p><ul>';e+=u.join("\n"),e+=f.join("\n"),e+="</ul></div>",document.querySelector(".errors").setAttribute("class","errors active"),document.querySelector(".errors").innerHTML=e,document.querySelector("body").setAttribute("class","idle")}window.addEventListener("load",function(){var e,r,t;e="shaders/buffers/milk.glsl",r=function(e){var s=e;o.main=null;var i=(e=(e=e.replace(new RegExp("(/{2} u_buffer_)(\\d+).*((.|[\\r\\n]+)*?)(?=/{2} u_buffer|/{2} main|$)","g"),function(e,r,t,a,n,i){return i=s.substr(0,i).split("\n").length,o.buffers["u_buffer_"+t]={fragment:a,offset:i},""})).replace(new RegExp("(/{2} main).*((.|[\\r\\n]+)*)(?=/{2} u_buffer|$)","g"),function(e,r,t,a,n){return o.main=t,""})).split("\n").length;for(var r in o.main&&s.replace(new RegExp("(/{2} main).*((.|[\\r\\n]+)*)(?=/{2} u_buffer|$)","g"),function(e,r,t,a,n){return n=s.substr(0,n).split("\n").length-i,""}),o.buffers)o.buffers[r].common=e,o.buffers[r].offset-=i;o.fragment=e+(o.main||""),o.offset=0,function(){var a=document.querySelector(".content"),n=document.querySelector(".shader"),e=document.querySelector(".btn-download");s(!0);var r,t,i=new CanvasService(n,{premultipliedAlpha:!1,preserveDrawingBuffer:!0,backgroundColor:"rgba(1,1,1,1)"});function s(e){var r=a.offsetWidth,t=a.offsetHeight;n.style.width=r+"px",n.style.height=t+"px",e?(n.width=r,n.height=t):i.resize()}i.on("error",l),i.on("render",function(){}),t=window.options,document.querySelector(".errors").setAttribute("class","errors"),document.querySelector(".welcome").setAttribute("class","welcome"),t.vertex=0<t.vertex.trim().length?t.vertex:null,t.fragment=0<t.fragment.trim().length?t.fragment:null,t.fragment||t.vertex?document.querySelector("body").setAttribute("class","ready"):document.querySelector("body").setAttribute("class","empty"),i.load(t.fragment,t.vertex,t.offset),i.loadPrograms(t.buffers),i.loadUniforms(t),e.addEventListener("click",function(){var a=new JSZip;Promise.all(["css/app.css","css/app.min.css","css/vendors.css","css/vendors.min.css","js/app.js","js/app.min.js","js/vendors.js","js/vendors.min.js","shaders/buffers/milk.glsl","index.html"].map(function(t){return new Promise(function(e){var r=new XMLHttpRequest;r.open("GET",t),r.onload=function(){a.file(t,this.responseText),e()},r.send()})})).then(function(){console.log(a),a.generateAsync({type:"blob"}).then(function(e){saveAs(e,"glsl-canvas.zip")})})}),window.addEventListener("resize",function(){r&&clearTimeout(r),r=setTimeout(s,50)}),s()}()},(t=new XMLHttpRequest).open("GET",e,!0),t.addEventListener("load",function(){r(t.responseText)}),t.send()})}();
//# sourceMappingURL=app.min.js.map
